- name: Deploy Windows Servers
  hosts: all
  gather_facts: False
  connection: local
  become: no
  vars:
    ansible_port: 5986
  vars_files:
    - node-config/nodes-vmware-mssql-on-linux.yml

  pre_tasks:
    - name: gather only registered virtual machine templates
      vmware_vm_facts:
        hostname: "{{ lookup('env', 'VMWARE_HOST')|default(providers.vcenter.hostname) }}"
        username: "{{ lookup('env', 'VMWARE_USER')|default(providers.vcenter.username) }}"
        password: "{{ lookup('env', 'VMWARE_PASSWORD')|default(providers.vcenter.password) }}"
        validate_certs: no
        vm_type: template
      register: template_facts

    - debug:
        var: template_facts.virtual_machines

    - name: check for non-existing templates
      set_fact:
        nodes_with_non_existing_templates: '{{ nodes | json_query(query) }}'
      vars:
        query: "@[?!contains(`{{ template_facts.virtual_machines.matches }}`, template)]"
      when: template_facts is success

    - debug:
        var: nodes_with_non_existing_templates

    - pause:

  roles:
  - ansible-role-vmware
  
